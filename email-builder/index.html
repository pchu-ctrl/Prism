<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Builder — Projects & Modules</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: { DEFAULT: '#605bff', 600: '#4f46e5', 700: '#4338ca' },
            ink: '#0f172a',
            muted: '#64748b'
          },
          boxShadow: {
            soft: '0 8px 24px rgba(15,23,42,.06)'
          },
          borderRadius: { xl: '0.875rem' }
        }
      }
    }
  </script>
  <style>
    :root{
      /* Color palette */
      --bg:#f7f8fb; --surface:#fff; --ink:#0f172a; --muted:#64748b;
      --brand:#0ea5e9; --brand-600:#0284c7;
      --success:#16a34a; --warn:#fbbf24; --danger:#ef4444;
      --border:#e5e7eb; --accent:#e0f2fe;
      /* Radii */
      --r-lg:14px; --r-md:10px; --r-sm:8px;
      /* Shadows */
      --shadow-xs:0 1px 2px rgba(15,23,42,.06);
      --shadow-sm:0 2px 4px rgba(15,23,42,.08);
      --shadow-md:0 8px 24px rgba(15,23,42,.06);
      /* Spacing */
      --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:24px; --space-6:32px;
      /* Typography */
      --fs-display:2rem; --fs-h1:1.5rem; --fs-h2:1.25rem; --fs-h3:1.125rem;
      --fs-h4:1rem; --fs-body:0.9375rem; --fs-small:0.8125rem;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);background:var(--bg);font-size:var(--fs-body);line-height:1.5
    }
    h1,h2,h3,h4{margin:0;font-weight:600;line-height:1.3}
    h1{font-size:var(--fs-h1)}
    h2{font-size:var(--fs-h2)}
    h3{font-size:var(--fs-h3)}
    h4{font-size:var(--fs-h4)}
    small{font-size:var(--fs-small)}
    a{color:inherit;text-decoration:none}
    .btn{
      appearance:none;border:0;cursor:pointer;padding:var(--space-2) var(--space-3);border-radius:999px;background:var(--surface);
      color:var(--brand);font-weight:700;font-size:var(--fs-small);box-shadow:var(--shadow-sm);transition:transform .06s ease;
      outline:2px solid transparent;outline-offset:2px
    }
    .btn.secondary{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.28)}
    .btn.ghost{background:var(--surface);color:var(--ink)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline-color:var(--brand-600)}
    .nav{display:flex;gap:var(--space-2);align-items:center}
    /* Header */
    .hidden{display:none!important}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-md);overflow:hidden}
    .bar{display:flex;align-items:center;gap:var(--space-2);padding:var(--space-3);border-bottom:1px solid var(--border);background:#fcfcff}
    .pill{font-size:var(--fs-small);color:var(--muted);background:#f3f4f6;padding:var(--space-1) var(--space-2);border-radius:999px;border:1px solid var(--border)}
    select,input[type="text"],textarea{
      width:100%;padding:var(--space-2) var(--space-3);border:1px solid var(--border);border-radius:999px;background:var(--surface);
      font:inherit;color:var(--ink);outline:2px solid transparent;outline-offset:2px
    }
    select:focus-visible,input[type="text"]:focus-visible,textarea:focus-visible{outline-color:var(--brand-600)}
    textarea{border-radius:var(--r-md)}
    /* Home */
    /* Projects list */
    .list{padding:12px}
    .proj-row{
      display:grid;grid-template-columns:1fr 180px 160px;gap:10px;align-items:center;
      padding:12px;border-bottom:1px solid var(--border);cursor:pointer
    }
    .empty{padding:16px}
    /* Modules repo (code editor) */
    .repo{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 160px)}
    .repo-list{border-right:1px solid var(--border);padding:16px;background:#fff}
    .repo-item{padding:10px 12px;border:1px solid var(--border);border-radius:var(--r-sm);margin-bottom:8px;cursor:pointer;background:#fff}
    .repo-item:hover{background:#f8fafc}
    .editor{padding:16px;display:grid;grid-template-rows:auto 1fr auto;gap:10px;background:#fff}
    .row{display:grid;grid-template-columns:220px 1fr auto;gap:10px;align-items:center}
    #modCode{height:50vh;resize:vertical}
    .muted{color:var(--muted)}
  </style>
</head>
<body class="font-sans">
  <header class="sticky top-0 z-10 w-full bg-gradient-to-r from-brand to-violet-600 text-white shadow">
    <div class="mx-auto max-w-6xl flex items-center justify-between px-4 py-3">
      <h1 class="text-base font-bold tracking-tight">Email Builder</h1>
      <div class="flex items-center gap-2">
        <div id="userSpot"></div>
      </div>
    </div>
  </header>

  <div class="flex min-h-screen">
    <aside class="w-48 bg-white border-r">
      <nav class="flex flex-col p-4 space-y-2">
        <a href="#/" class="rounded px-3 py-2 hover:bg-slate-100">Home</a>
        <a href="#/projects" class="rounded px-3 py-2 hover:bg-slate-100">Projects</a>
        <a href="#/modules" class="rounded px-3 py-2 hover:bg-slate-100">Modules</a>
      </nav>
    </aside>

    <main class="flex-1">
      <div class="mx-auto max-w-5xl p-4">
    <!-- HOME -->
    <section id="view-home" class="flex flex-col items-center justify-center text-center py-20">
      <div>
        <h2 class="text-3xl font-bold tracking-tight text-ink">Build Emails Fast</h2>
        <p class="mt-2 text-lg text-muted">Manage projects and modules to craft emails in seconds.</p>
        <p class="mt-10 text-sm text-slate-600">Use the sidebar to navigate between projects and modules.</p>
      </div>
    </section>

    <!-- PROJECTS LIST -->
    <section id="view-projects" class="card hidden">
      <div class="bar">
        <strong>Projects</strong>
        <div style="flex:1"></div>
        <button class="btn" onclick="newProject()">New Project</button>
      </div>
      <div id="projectsList" class="list"></div>
    </section>

    <!-- MODULES (Repo / Code Editor) -->
    <section id="view-modules" class="card hidden">
      <div class="bar">
        <strong>Module Repo</strong>
        <div style="flex:1"></div>
        <button class="btn" id="btnNew">New</button>
      </div>
      <div class="repo">
        <aside class="repo-list"><div id="repoList"></div></aside>
        <section class="editor">
          <div class="row">
            <input id="modName" type="text" placeholder="Module name (e.g., Hero CTA)" />
            <span id="modIdBadge" class="pill">New</span>
            <div class="nav">
              <button class="btn" id="btnSaveModule">Save</button>
              <button class="btn danger" id="btnDeleteModule">Delete</button>
            </div>
          </div>
          <textarea id="modCode" placeholder="Paste module HTML with {{variables}} here..."></textarea>
          <div class="muted">Tip: use <code>{{headline}}</code>, <code>{{ctaUrl}}</code>, <code>{{brandColor}}</code>.
            Hex colors can be typed with or without <code>#</code>; we display with <code>#</code>.</div>
        </section>
      </div>
    </section>

    <!-- AUTH PLACEHOLDER -->
    <section id="view-auth" class="card hidden"></section>
      </div>
    </main>
  </div>

  <script>
    /* ===== Storage keys ===== */
    const MODULES_KEY  = "pro_modules_v6";
    const PROJECTS_KEY = "pro_projects_v1";

    /* ===== State ===== */
    let modules = [];   // [{id, name, code}]
    let projects = [];  // [{id, name, instances:[{instanceId,moduleId,values:{}}], createdAt, updatedAt}]
    let editingModuleId = null;

    /* ===== DOM Helpers ===== */
    const $ = s => document.querySelector(s);
    const qs = (node, s) => node.querySelector(s);

    const views = {
      home: $("#view-home"),
      projects: $("#view-projects"),
      modules: $("#view-modules"),
      auth: $("#view-auth")
    };

    const projectsList = $("#projectsList");

    const repoList = $("#repoList");
    const modName = $("#modName");
    const modCode = $("#modCode");
    const modIdBadge = $("#modIdBadge");
    const btnNew = $("#btnNew");
    const btnSaveModule = $("#btnSaveModule");
    const btnDeleteModule = $("#btnDeleteModule");

    /* ===== Router ===== */
    function go(hash){ location.hash = hash; }
    window.addEventListener("hashchange", renderRoute);

    function renderRoute(){
      // hide all
      Object.values(views).forEach(v => v.classList.add("hidden"));

      const [_, route] = location.hash.split("/");
      switch(route){
        case "projects":
          views.projects.classList.remove("hidden");
          renderProjectsList();
          break;
        case "modules":
          views.modules.classList.remove("hidden");
          renderRepo();
          break;
        case "auth":
          views.auth.classList.remove("hidden");
          break;
        default:
          views.home.classList.remove("hidden");
      }
    }

    /* ===== Persistence ===== */
    function saveModules(){ localStorage.setItem(MODULES_KEY, JSON.stringify(modules)); }
    function saveProjects(){ localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects)); }

    function loadAll(){
      modules = JSON.parse(localStorage.getItem(MODULES_KEY)  || "[]");
      projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
      if (modules.length === 0) seedStarterModules();
      // scrub: ensure all project instances reference existing modules
      projects.forEach(p => {
        p.tags = p.tags || [];
        p.instances = (p.instances || []).filter(inst => modules.some(m => m.id === inst.moduleId));
        // normalize colors once on load
        (p.instances || []).forEach(inst => {
          if (!inst.values) return;
          Object.keys(inst.values).forEach(k => inst.values[k] = normalizeHexIfColor(k, inst.values[k]));
        });
      });
      saveModules(); saveProjects();
    }

    /* ===== Modules starter pack (header + 10 content + footer) ===== */
    function seedStarterModules(){
      const m = [];
      const add = (name, code) => m.push({ id: uid("mod"), name, code: code.trim() });

      // HEADER
      add("HEADER — Wrapper + Preheader + Logo", `
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>{{emailTitle}}</title>
<style>
body { margin:0; padding:0; background:#f5f6fa; }
table { border-collapse:collapse; }
img { border:0; line-height:100%; outline:none; text-decoration:none; display:block; }
a { color: {{brandColor}}; }
@media only screen and (max-width:620px){ .container { width:100% !important; } .stack { display:block !important; width:100% !important; } }
</style>
</head>
<body style="margin:0; padding:0; background:#f5f6fa;">
<div style="display:none; font-size:0; line-height:0; max-height:0; max-width:0; opacity:0; overflow:hidden;">{{preheaderText}}</div>
<table width="100%" cellpadding="0" cellspacing="0" role="presentation" style="background:#f5f6fa; padding:24px 0;">
  <tr><td align="center">
    <table class="container" width="600" cellpadding="0" cellspacing="0" role="presentation" style="width:600px; background:#ffffff; border-radius:12px; border:1px solid #e5e7eb; font-family:Arial, sans-serif;">
      <tr><td align="left" style="padding:20px 28px; border-bottom:1px solid #e5e7eb;">
        <a href="{{brandHomeUrl}}" style="text-decoration:none;"><img src="{{logoUrl}}" alt="Logo" width="140" style="height:auto;"></a>
      </td></tr>
`.trim());

      // 1–10 content modules
      add("Hero — Full Image", `
<tr><td align="center" style="padding:0;">
  <img src="{{heroImageUrl}}" alt="{{heroAlt}}" width="600" style="width:100%; height:auto; border-radius:0 0 12px 12px;">
</td></tr>
`.trim());

      add("Section — Headline + Subhead + CTA", `
<tr><td align="center" style="padding:32px 28px;">
  <div style="font-size:28px; color:#111827; font-weight:bold; padding-bottom:8px;">{{headlineText}}</div>
  <div style="font-size:16px; color:#6b7280; padding-bottom:20px;">{{subheadText}}</div>
  <a href="{{ctaURL}}" style="display:inline-block; background:{{ctaColor}}; color:#ffffff; text-decoration:none; padding:12px 20px; border-radius:8px; font-weight:bold;">{{ctaText}}</a>
</td></tr>
`.trim());

      add("2-Column — Text + Text", `
<tr><td align="center" style="padding:20px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="50%" valign="top" style="padding:10px 10px 10px 0;">
        <div style="font-size:18px; font-weight:bold; color:#111827; padding-bottom:6px;">{{leftTitle}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6;">{{leftText}}</div>
      </td>
      <td class="stack" width="50%" valign="top" style="padding:10px 0 10px 10px;">
        <div style="font-size:18px; font-weight:bold; color:#111827; padding-bottom:6px;">{{rightTitle}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6;">{{rightText}}</div>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("2-Column — Image + Text", `
<tr><td align="center" style="padding:20px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="50%" align="center" style="padding:10px;">
        <img src="{{leftImageUrl}}" width="260" style="border-radius:8px; display:block; width:100%; height:auto;" alt="">
        <div style="font-size:14px; color:#374151; padding-top:8px;">{{leftCaption}}</div>
      </td>
      <td class="stack" width="50%" align="center" style="padding:10px;">
        <img src="{{rightImageUrl}}" width="260" style="border-radius:8px; display:block; width:100%; height:auto;" alt="">
        <div style="font-size:14px; color:#374151; padding-top:8px;">{{rightCaption}}</div>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("3-Column — Feature Icons", `
<tr><td align="center" style="padding:24px 20px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="33.33%" align="center" style="padding:10px;">
        <img src="{{icon1Url}}" width="48" height="48" alt="" style="margin-bottom:8px;">
        <div style="font-size:16px; font-weight:bold; color:#111827;">{{title1}}</div>
        <div style="font-size:13px; color:#6b7280; line-height:1.6;">{{text1}}</div>
      </td>
      <td class="stack" width="33.33%" align="center" style="padding:10px;">
        <img src="{{icon2Url}}" width="48" height="48" alt="" style="margin-bottom:8px;">
        <div style="font-size:16px; font-weight:bold; color:#111827;">{{title2}}</div>
        <div style="font-size:13px; color:#6b7280; line-height:1.6;">{{text2}}</div>
      </td>
      <td class="stack" width="33.33%" align="center" style="padding:10px;">
        <img src="{{icon3Url}}" width="48" height="48" alt="" style="margin-bottom:8px;">
        <div style="font-size:16px; font-weight:bold; color:#111827;">{{title3}}</div>
        <div style="font-size:13px; color:#6b7280; line-height:1.6;">{{text3}}</div>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Media — Image Left, Text Right", `
<tr><td align="center" style="padding:24px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="40%" align="left" style="padding-right:16px;">
        <img src="{{mediaImageUrl}}" width="220" style="border-radius:8px; width:100%; height:auto;" alt="">
      </td>
      <td class="stack" width="60%" align="left" style="padding-left:16px;">
        <div style="font-size:20px; font-weight:bold; color:#111827; padding-bottom:6px;">{{mediaTitle}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6; padding-bottom:12px;">{{mediaText}}</div>
        <a href="{{mediaCtaUrl}}" style="display:inline-block; background:{{mediaCtaColor}}; color:#fff; text-decoration:none; padding:10px 16px; border-radius:6px; font-weight:bold;">{{mediaCtaText}}</a>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Media — Text Left, Image Right", `
<tr><td align="center" style="padding:24px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="60%" align="left" style="padding-right:16px;">
        <div style="font-size:20px; font-weight:bold; color:#111827; padding-bottom:6px;">{{media2Title}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6; padding-bottom:12px;">{{media2Text}}</div>
        <a href="{{media2CtaUrl}}" style="display:inline-block; background:{{media2CtaColor}}; color:#fff; text-decoration:none; padding:10px 16px; border-radius:6px; font-weight:bold;">{{media2CtaText}}</a>
      </td>
      <td class="stack" width="40%" align="left" style="padding-left:16px;">
        <img src="{{media2ImageUrl}}" width="220" style="border-radius:8px; width:100%; height:auto;" alt="">
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Banner — CTA Strip", `
<tr><td align="center" style="padding:0;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0" style="background:{{bannerBg}};">
    <tr>
      <td align="center" style="padding:16px 28px;">
        <div style="font-size:18px; color:#ffffff; font-weight:600; padding-bottom:10px;">{{bannerText}}</div>
        <a href="{{bannerCtaUrl}}" style="display:inline-block; background:#ffffff; color:{{bannerBg}}; text-decoration:none; padding:10px 16px; border-radius:6px; font-weight:bold;">{{bannerCtaText}}</a>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Social Proof — Testimonial", `
<tr><td align="center" style="padding:28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0" style="border:1px solid #e5e7eb; border-radius:10px;">
    <tr><td align="left" style="padding:20px;">
      <div style="font-size:18px; line-height:1.6; color:#111827; font-style:italic;">“{{quote}}”</div>
      <table role="presentation" cellpadding="0" cellspacing="0" style="margin-top:12px;">
        <tr>
          <td width="40"><img src="{{avatarUrl}}" width="40" height="40" style="border-radius:999px;" alt=""></td>
          <td style="padding-left:10px;">
            <div style="font-size:14px; font-weight:bold; color:#111827;">{{author}}</div>
            <div style="font-size:12px; color:#6b7280;">{{role}}</div>
          </td>
        </tr>
      </table>
    </td></tr>
  </table>
</td></tr>
`.trim());

      add("Grid — Products 2x2", `
<tr><td align="center" style="padding:20px 16px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p1Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p1Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p1Desc}}</div>
        <a href="{{p1Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p1Cta}}</a>
      </td>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p2Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p2Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p2Desc}}</div>
        <a href="{{p2Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p2Cta}}</a>
      </td>
    </tr>
    <tr>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p3Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p3Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p3Desc}}</div>
        <a href="{{p3Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p3Cta}}</a>
      </td>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p4Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p4Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p4Desc}}</div>
        <a href="{{p4Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p4Cta}}</a>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Section — Rich Text", `
<tr><td align="left" style="padding:24px 28px;">
  <div style="font-size:20px; font-weight:bold; color:#111827; padding-bottom:8px;">{{richTitle}}</div>
  <div style="font-size:14px; color:#374151; line-height:1.7;">{{richBody}}</div>
</td></tr>
`.trim());

      // FOOTER
      add("FOOTER — Social + Legal + Close", `
<tr><td align="center" style="padding:24px 28px; border-top:1px solid #e5e7eb;">
  <table role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td style="padding:0 6px;"><a href="{{facebookUrl}}"><img src="{{facebookIconUrl}}" alt="Facebook" width="24" height="24"></a></td>
      <td style="padding:0 6px;"><a href="{{twitterUrl}}"><img src="{{twitterIconUrl}}" alt="Twitter" width="24" height="24"></a></td>
      <td style="padding:0 6px;"><a href="{{linkedinUrl}}"><img src="{{linkedinIconUrl}}" alt="LinkedIn" width="24" height="24"></a></td>
      <td style="padding:0 6px;"><a href="{{instagramUrl}}"><img src="{{instagramIconUrl}}" alt="Instagram" width="24" height="24"></a></td>
    </tr>
  </table>
  <div style="font-size:12px; color:#6b7280; line-height:1.6; padding-top:12px;">
    {{companyAddress}} • <a href="{{unsubscribeUrl}}" style="color:{{brandColor}}; text-decoration:underline;">Unsubscribe</a>
  </div>
</td></tr>
</table></td></tr></table></body></html>
`.trim());

      modules = m;
      saveModules();
    }

    /* ===== Utils ===== */
    function uid(p="id"){ return p+"_"+Math.random().toString(36).slice(2,8)+Date.now().toString(36); }
    function getProject(id){ return projects.find(p => p.id === id); }
    function getModule(id){ return modules.find(m => m.id === id); }
    function normalizeHexIfColor(key, value){
      if (!value) return value;
      if (!/(color|colour|bg|background|brand|ctaColor|bannerBg)/i.test(key)) return value;
      let v = String(value).trim(); if (!v) return v;
      if (v.startsWith("#")) v = v.slice(1);
      if (/^[0-9a-fA-F]{3}$/.test(v) || /^[0-9a-fA-F]{6}$/.test(v)) return "#" + v.toUpperCase();
      return value;
    }

    /* ===== Projects list ===== */
    function renderProjectsList(){
      projectsList.innerHTML = "";
      if (projects.length === 0){
        projectsList.innerHTML = `<div class="empty pill">No projects yet — click “New Project”.</div>`;
        return;
      }
      projects
        .slice()
        .sort((a,b)=> new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt))
        .forEach(p => {
          const row = document.createElement("div");
          row.className = "proj-row";
          const count = (p.instances||[]).length;
          const tagHtml = (p.tags || []).map(t => `<span class="pill">${t}</span>`).join(" ");
          row.innerHTML = `
            <div><strong>${p.name}</strong> ${tagHtml}</div>
            <div class="pill">${count} module${count!==1?"s":""}</div>
            <div class="pill">${new Date(p.updatedAt||p.createdAt).toLocaleString()}</div>
          `;
          row.addEventListener("click", () => editProjectTags(p.id));
          projectsList.appendChild(row);
        });
    }
    function editProjectTags(id){
      const p = getProject(id); if (!p) return;
      const current = (p.tags || []).join(', ');
      const input = prompt('Tags? (comma separated)', current);
      if (input === null) return;
      p.tags = input.split(',').map(t => t.trim()).filter(Boolean);
      p.updatedAt = new Date().toISOString();
      saveProjects();
      renderProjectsList();
    }
    function newProject(){
      const name = prompt("Project name?");
      if (!name) return;
      const tagInput = prompt("Tags? (comma separated)");
      const tags = tagInput ? tagInput.split(',').map(t=>t.trim()).filter(Boolean) : [];
      const id = uid("proj");
      const now = new Date().toISOString();
      projects.push({ id, name, tags, createdAt: now, updatedAt: now, instances: [] });
      saveProjects();
      go("#/projects");
    }


    /* ===== Modules Repo (Code Editor) ===== */
    function renderRepo(){
      repoList.innerHTML = "";
      modules.forEach(m => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <strong>${m.name}</strong><span class="pill">${m.id}</span>
        </div>`;
        item.addEventListener("click", ()=> loadModuleForEdit(m.id));
        repoList.appendChild(item);
      });
      if (editingModuleId){
        const mm = modules.find(x => x.id === editingModuleId);
        if (mm){ modName.value = mm.name; modCode.value = mm.code; modIdBadge.textContent = mm.id; }
      } else {
        modName.value = ""; modCode.value = ""; modIdBadge.textContent = "New";
      }
    }
    function loadModuleForEdit(id){
      const m = modules.find(x => x.id === id); if (!m) return;
      editingModuleId = id; modName.value = m.name; modCode.value = m.code; modIdBadge.textContent = id;
    }
    btnNew.addEventListener("click", ()=>{ editingModuleId = null; modName.value = ""; modCode.value = ""; modIdBadge.textContent = "New"; });
    btnSaveModule.addEventListener("click", ()=>{
      const name = modName.value.trim(); const code = modCode.value;
      if (!name || !code){ alert("Please provide a module name and HTML"); return; }
      if (editingModuleId){
        const i = modules.findIndex(m => m.id === editingModuleId);
        if (i >= 0) modules[i] = { ...modules[i], name, code };
      } else {
        const id = uid("mod"); modules.push({ id, name, code }); editingModuleId = id; modIdBadge.textContent = id;
      }
      saveModules(); renderRepo();
    });
    btnDeleteModule.addEventListener("click", ()=>{
      if (!editingModuleId) return;
      const id = editingModuleId;
      // remove from modules
      modules = modules.filter(m => m.id !== id);
      saveModules();
      // remove instances referencing it
      projects.forEach(p => {
        const before = p.instances?.length || 0;
        p.instances = (p.instances || []).filter(inst => inst.moduleId !== id);
        if (p.instances.length !== before) p.updatedAt = new Date().toISOString();
      });
      saveProjects();
      editingModuleId = null; modName.value = ""; modCode.value = ""; modIdBadge.textContent = "New";
      renderRepo();
    });


    /* ===== Boot ===== */
    (function init(){
      loadAll();
      renderRoute();
    })();
  </script>
</body>
</html>
