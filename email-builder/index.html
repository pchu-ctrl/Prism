<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Builder ‚Äî Projects & Modules</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fb; --surface:#fff; --ink:#0f172a; --muted:#64748b; --brand:#605bff; --brand2:#7c3aed;
      --border:#e5e7eb; --accent:#eef2ff; --danger:#ef4444; --shadow:0 8px 24px rgba(15,23,42,.06);
      --r-lg:14px; --r-md:10px; --r-sm:8px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    a{color:inherit;text-decoration:none}
    /* Header */
    header{
      position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;
      padding:14px 20px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;box-shadow:var(--shadow)
    }
    header h1{margin:0;font-size:16px;letter-spacing:.3px;font-weight:700}
    .nav{display:flex;gap:10px;align-items:center}
    .btn{
      appearance:none;border:0;cursor:pointer;padding:9px 14px;border-radius:999px;background:#fff;color:var(--brand);
      font-weight:700;box-shadow:0 4px 16px rgba(0,0,0,.08);transition:transform .06s ease
    }
    .btn.secondary{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.28)}
    .btn.ghost{background:#fff;color:#0f172a}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:active{transform:translateY(1px)}
    main{padding:16px}
    .hidden{display:none!important}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow);overflow:hidden}
    .bar{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--border);background:#fcfcff}
    .pill{font-size:12px;color:var(--muted);background:#f3f4f6;padding:4px 10px;border-radius:999px;border:1px solid var(--border)}
    select,input[type="text"],textarea{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;font:inherit;color:var(--ink);outline:none
    }
    textarea{border-radius:var(--r-md)}
    /* Home */
    .home-wrap{display:grid;place-items:center;height:calc(100vh - 100px)}
    .home-grid{display:grid;grid-template-columns:repeat(2, minmax(220px, 300px));gap:20px}
    .home-tile{
      display:flex;align-items:center;justify-content:center;gap:10px;height:140px;background:#fff;border:1px solid var(--border);
      border-radius:20px;box-shadow:var(--shadow);font-weight:800;font-size:20px;cursor:pointer
    }
    /* Projects list */
    .list{padding:12px}
    .proj-row{
      display:grid;grid-template-columns:1fr 180px 160px 120px;gap:10px;align-items:center;
      padding:12px;border-bottom:1px solid var(--border)
    }
    .empty{padding:16px}
    /* Composer layout */
    .grid{display:grid;grid-template-columns:40% 60%;min-height:calc(100vh - 185px)}
    .nv{border-right:1px solid var(--border);background:#fff;display:grid;grid-template-rows:auto 1fr}
    .nv-head{display:grid;grid-template-columns:1fr 1fr;gap:0;padding:10px 16px;border-bottom:1px solid var(--border)}
    .nv-head h3,.preview-head h3{margin:0;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted)}
    .nv-body{overflow:auto}
    .nv-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;padding:16px}
    .sep{
      grid-column:1 / span 2;display:flex;align-items:center;justify-content:space-between;
      padding:8px 12px;margin:0 0 10px;background:var(--accent);border:1px dashed #c7d2fe;border-radius:999px;user-select:none
    }
    .handle{cursor:grab;color:#4338ca;display:flex;align-items:center;gap:8px}
    .drop{grid-column:1 / span 2;height:10px;border-radius:999px;background:#c7d2fe;opacity:0;transform:scaleY(.5);transition:.15s ease;margin:6px 0}
    .drop.active{opacity:1;transform:scaleY(1)}
    .name-chip{padding:10px 12px;border-radius:999px;background:#f8fafc;border:1px solid var(--border);font-size:14px;color:#111827;margin:0 12px 8px 0}
    .value-row input{width:100%;border-radius:999px;background:#fff;border:1px solid var(--border);padding:10px 12px;margin:0 0 8px 12px}
    .preview-wrap{background:#fff}
    .preview-head{padding:10px 16px;border-bottom:1px solid var(--border)}
    .preview{height:100%;overflow:auto;padding:16px}
    .frame{margin:8px 0}
    /* Modules repo (code editor) */
    .repo{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 160px)}
    .repo-list{border-right:1px solid var(--border);padding:16px;background:#fff}
    .repo-item{padding:10px 12px;border:1px solid var(--border);border-radius:var(--r-sm);margin-bottom:8px;cursor:pointer;background:#fff}
    .repo-item:hover{background:#f8fafc}
    .editor{padding:16px;display:grid;grid-template-rows:auto 1fr auto;gap:10px;background:#fff}
    .row{display:grid;grid-template-columns:220px 1fr auto;gap:10px;align-items:center}
    #modCode{height:50vh;resize:vertical}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Email Builder</h1>
    <div class="nav">
      <button class="btn secondary" onclick="go('#/')">Home</button>
      <button class="btn secondary" onclick="go('#/projects')">Projects</button>
      <button class="btn secondary" onclick="go('#/modules')">Modules</button>
      <button id="btnCopy" class="btn hidden" title="Copy Final HTML from Composer">Copy HTML</button>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="view-home" class="home-wrap">
      <div class="home-grid">
        <div class="home-tile" onclick="go('#/projects')">üìÑ Projects</div>
        <div class="home-tile" onclick="go('#/modules')">üß© Modules</div>
      </div>
    </section>

    <!-- PROJECTS LIST -->
    <section id="view-projects" class="card hidden">
      <div class="bar">
        <strong>Projects</strong>
        <div style="flex:1"></div>
        <button class="btn" onclick="newProject()">New Project</button>
      </div>
      <div id="projectsList" class="list"></div>
    </section>

    <!-- COMPOSER (per project) -->
    <section id="view-composer" class="card hidden">
      <div class="bar">
        <button class="btn ghost" onclick="go('#/projects')">‚Üê Back to Projects</button>
        <span id="composerProjectName" class="pill"></span>
        <span class="pill">Drag to reorder ‚Ä¢ Names & values scroll together ‚Ä¢ Colors auto-normalize</span>
      </div>

      <div class="grid">
        <!-- Left 40%: Names + Values inside shared scroll -->
        <div class="nv">
          <div class="nv-head">
            <h3>Variable Names</h3>
            <h3>Values</h3>
          </div>
          <div class="nv-body">
            <div id="nvGrid" class="nv-grid"></div>

            <!-- Add module controls under existing modules -->
            <div style="padding:0 16px 16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div style="grid-column:1 / span 2;">
                <div class="pill" style="display:inline-block">Add a module below</div>
              </div>
              <div><select id="addSelect"></select></div>
              <div><button class="btn ghost" id="btnAdd">Add Module</button></div>
            </div>
          </div>
        </div>

        <!-- Right 60%: Preview -->
        <div class="preview-wrap">
          <div class="preview-head"><h3>Combined Preview</h3></div>
          <div id="previewCol" class="preview"></div>
        </div>
      </div>
    </section>

    <!-- MODULES (Repo / Code Editor) -->
    <section id="view-modules" class="card hidden">
      <div class="bar">
        <strong>Module Repo</strong>
        <div style="flex:1"></div>
        <button class="btn" id="btnNew">New</button>
      </div>
      <div class="repo">
        <aside class="repo-list"><div id="repoList"></div></aside>
        <section class="editor">
          <div class="row">
            <input id="modName" type="text" placeholder="Module name (e.g., Hero CTA)" />
            <span id="modIdBadge" class="pill">New</span>
            <div class="nav">
              <button class="btn" id="btnSaveModule">Save</button>
              <button class="btn danger" id="btnDeleteModule">Delete</button>
            </div>
          </div>
          <textarea id="modCode" placeholder="Paste module HTML with {{variables}} here..."></textarea>
          <div class="muted">Tip: use <code>{{headline}}</code>, <code>{{ctaUrl}}</code>, <code>{{brandColor}}</code>.
            Hex colors can be typed with or without <code>#</code>; we display with <code>#</code>.</div>
        </section>
      </div>
    </section>
  </main>

  <script>
    /* ===== Storage keys ===== */
    const MODULES_KEY  = "pro_modules_v6";
    const PROJECTS_KEY = "pro_projects_v1";

    /* ===== State ===== */
    let modules = [];   // [{id, name, code}]
    let projects = [];  // [{id, name, instances:[{instanceId,moduleId,values:{}}], createdAt, updatedAt}]
    let editingModuleId = null;
    let currentProjectId = null;

    /* ===== DOM Helpers ===== */
    const $ = s => document.querySelector(s);
    const qs = (node, s) => node.querySelector(s);

    const views = {
      home: $("#view-home"),
      projects: $("#view-projects"),
      composer: $("#view-composer"),
      modules: $("#view-modules")
    };

    const nvGrid = $("#nvGrid");
    const previewCol = $("#previewCol");
    const addSelect = $("#addSelect");
    const btnAdd = $("#btnAdd");
    const btnCopy = $("#btnCopy");
    const projectsList = $("#projectsList");
    const composerProjectName = $("#composerProjectName");

    const repoList = $("#repoList");
    const modName = $("#modName");
    const modCode = $("#modCode");
    const modIdBadge = $("#modIdBadge");
    const btnNew = $("#btnNew");
    const btnSaveModule = $("#btnSaveModule");
    const btnDeleteModule = $("#btnDeleteModule");

    /* ===== Router ===== */
    function go(hash){ location.hash = hash; }
    window.addEventListener("hashchange", renderRoute);

    function renderRoute(){
      // hide all
      Object.values(views).forEach(v => v.classList.add("hidden"));
      btnCopy.classList.add("hidden");

      const [_, route, arg] = location.hash.split("/");
      switch(route){
        case "projects":
          views.projects.classList.remove("hidden");
          renderProjectsList();
          break;
        case "modules":
          views.modules.classList.remove("hidden");
          renderRepo();
          break;
        case "composer":
          currentProjectId = arg || null;
          if (!currentProjectId || !getProject(currentProjectId)){
            go("#/projects"); return;
          }
          views.composer.classList.remove("hidden");
          btnCopy.classList.remove("hidden");
          buildAddDropdown();
          renderComposerInputs();
          renderPreviewOnly();
          composerProjectName.textContent = getProject(currentProjectId).name;
          break;
        default:
          views.home.classList.remove("hidden");
      }
    }

    /* ===== Persistence ===== */
    function saveModules(){ localStorage.setItem(MODULES_KEY, JSON.stringify(modules)); }
    function saveProjects(){ localStorage.setItem(PROJECTS_KEY, JSON.stringify(projects)); }

    function loadAll(){
      modules = JSON.parse(localStorage.getItem(MODULES_KEY)  || "[]");
      projects = JSON.parse(localStorage.getItem(PROJECTS_KEY) || "[]");
      if (modules.length === 0) seedStarterModules();
      // scrub: ensure all project instances reference existing modules
      projects.forEach(p => {
        p.instances = (p.instances || []).filter(inst => modules.some(m => m.id === inst.moduleId));
        // normalize colors once on load
        (p.instances || []).forEach(inst => {
          if (!inst.values) return;
          Object.keys(inst.values).forEach(k => inst.values[k] = normalizeHexIfColor(k, inst.values[k]));
        });
      });
      saveModules(); saveProjects();
    }

    /* ===== Modules starter pack (header + 10 content + footer) ===== */
    function seedStarterModules(){
      const m = [];
      const add = (name, code) => m.push({ id: uid("mod"), name, code: code.trim() });

      // HEADER
      add("HEADER ‚Äî Wrapper + Preheader + Logo", `
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>{{emailTitle}}</title>
<style>
body { margin:0; padding:0; background:#f5f6fa; }
table { border-collapse:collapse; }
img { border:0; line-height:100%; outline:none; text-decoration:none; display:block; }
a { color: {{brandColor}}; }
@media only screen and (max-width:620px){ .container { width:100% !important; } .stack { display:block !important; width:100% !important; } }
</style>
</head>
<body style="margin:0; padding:0; background:#f5f6fa;">
<div style="display:none; font-size:0; line-height:0; max-height:0; max-width:0; opacity:0; overflow:hidden;">{{preheaderText}}</div>
<table width="100%" cellpadding="0" cellspacing="0" role="presentation" style="background:#f5f6fa; padding:24px 0;">
  <tr><td align="center">
    <table class="container" width="600" cellpadding="0" cellspacing="0" role="presentation" style="width:600px; background:#ffffff; border-radius:12px; border:1px solid #e5e7eb; font-family:Arial, sans-serif;">
      <tr><td align="left" style="padding:20px 28px; border-bottom:1px solid #e5e7eb;">
        <a href="{{brandHomeUrl}}" style="text-decoration:none;"><img src="{{logoUrl}}" alt="Logo" width="140" style="height:auto;"></a>
      </td></tr>
`.trim());

      // 1‚Äì10 content modules
      add("Hero ‚Äî Full Image", `
<tr><td align="center" style="padding:0;">
  <img src="{{heroImageUrl}}" alt="{{heroAlt}}" width="600" style="width:100%; height:auto; border-radius:0 0 12px 12px;">
</td></tr>
`.trim());

      add("Section ‚Äî Headline + Subhead + CTA", `
<tr><td align="center" style="padding:32px 28px;">
  <div style="font-size:28px; color:#111827; font-weight:bold; padding-bottom:8px;">{{headlineText}}</div>
  <div style="font-size:16px; color:#6b7280; padding-bottom:20px;">{{subheadText}}</div>
  <a href="{{ctaURL}}" style="display:inline-block; background:{{ctaColor}}; color:#ffffff; text-decoration:none; padding:12px 20px; border-radius:8px; font-weight:bold;">{{ctaText}}</a>
</td></tr>
`.trim());

      add("2-Column ‚Äî Text + Text", `
<tr><td align="center" style="padding:20px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="50%" valign="top" style="padding:10px 10px 10px 0;">
        <div style="font-size:18px; font-weight:bold; color:#111827; padding-bottom:6px;">{{leftTitle}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6;">{{leftText}}</div>
      </td>
      <td class="stack" width="50%" valign="top" style="padding:10px 0 10px 10px;">
        <div style="font-size:18px; font-weight:bold; color:#111827; padding-bottom:6px;">{{rightTitle}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6;">{{rightText}}</div>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("2-Column ‚Äî Image + Text", `
<tr><td align="center" style="padding:20px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="50%" align="center" style="padding:10px;">
        <img src="{{leftImageUrl}}" width="260" style="border-radius:8px; display:block; width:100%; height:auto;" alt="">
        <div style="font-size:14px; color:#374151; padding-top:8px;">{{leftCaption}}</div>
      </td>
      <td class="stack" width="50%" align="center" style="padding:10px;">
        <img src="{{rightImageUrl}}" width="260" style="border-radius:8px; display:block; width:100%; height:auto;" alt="">
        <div style="font-size:14px; color:#374151; padding-top:8px;">{{rightCaption}}</div>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("3-Column ‚Äî Feature Icons", `
<tr><td align="center" style="padding:24px 20px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="33.33%" align="center" style="padding:10px;">
        <img src="{{icon1Url}}" width="48" height="48" alt="" style="margin-bottom:8px;">
        <div style="font-size:16px; font-weight:bold; color:#111827;">{{title1}}</div>
        <div style="font-size:13px; color:#6b7280; line-height:1.6;">{{text1}}</div>
      </td>
      <td class="stack" width="33.33%" align="center" style="padding:10px;">
        <img src="{{icon2Url}}" width="48" height="48" alt="" style="margin-bottom:8px;">
        <div style="font-size:16px; font-weight:bold; color:#111827;">{{title2}}</div>
        <div style="font-size:13px; color:#6b7280; line-height:1.6;">{{text2}}</div>
      </td>
      <td class="stack" width="33.33%" align="center" style="padding:10px;">
        <img src="{{icon3Url}}" width="48" height="48" alt="" style="margin-bottom:8px;">
        <div style="font-size:16px; font-weight:bold; color:#111827;">{{title3}}</div>
        <div style="font-size:13px; color:#6b7280; line-height:1.6;">{{text3}}</div>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Media ‚Äî Image Left, Text Right", `
<tr><td align="center" style="padding:24px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="40%" align="left" style="padding-right:16px;">
        <img src="{{mediaImageUrl}}" width="220" style="border-radius:8px; width:100%; height:auto;" alt="">
      </td>
      <td class="stack" width="60%" align="left" style="padding-left:16px;">
        <div style="font-size:20px; font-weight:bold; color:#111827; padding-bottom:6px;">{{mediaTitle}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6; padding-bottom:12px;">{{mediaText}}</div>
        <a href="{{mediaCtaUrl}}" style="display:inline-block; background:{{mediaCtaColor}}; color:#fff; text-decoration:none; padding:10px 16px; border-radius:6px; font-weight:bold;">{{mediaCtaText}}</a>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Media ‚Äî Text Left, Image Right", `
<tr><td align="center" style="padding:24px 28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="60%" align="left" style="padding-right:16px;">
        <div style="font-size:20px; font-weight:bold; color:#111827; padding-bottom:6px;">{{media2Title}}</div>
        <div style="font-size:14px; color:#374151; line-height:1.6; padding-bottom:12px;">{{media2Text}}</div>
        <a href="{{media2CtaUrl}}" style="display:inline-block; background:{{media2CtaColor}}; color:#fff; text-decoration:none; padding:10px 16px; border-radius:6px; font-weight:bold;">{{media2CtaText}}</a>
      </td>
      <td class="stack" width="40%" align="left" style="padding-left:16px;">
        <img src="{{media2ImageUrl}}" width="220" style="border-radius:8px; width:100%; height:auto;" alt="">
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Banner ‚Äî CTA Strip", `
<tr><td align="center" style="padding:0;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0" style="background:{{bannerBg}};">
    <tr>
      <td align="center" style="padding:16px 28px;">
        <div style="font-size:18px; color:#ffffff; font-weight:600; padding-bottom:10px;">{{bannerText}}</div>
        <a href="{{bannerCtaUrl}}" style="display:inline-block; background:#ffffff; color:{{bannerBg}}; text-decoration:none; padding:10px 16px; border-radius:6px; font-weight:bold;">{{bannerCtaText}}</a>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Social Proof ‚Äî Testimonial", `
<tr><td align="center" style="padding:28px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0" style="border:1px solid #e5e7eb; border-radius:10px;">
    <tr><td align="left" style="padding:20px;">
      <div style="font-size:18px; line-height:1.6; color:#111827; font-style:italic;">‚Äú{{quote}}‚Äù</div>
      <table role="presentation" cellpadding="0" cellspacing="0" style="margin-top:12px;">
        <tr>
          <td width="40"><img src="{{avatarUrl}}" width="40" height="40" style="border-radius:999px;" alt=""></td>
          <td style="padding-left:10px;">
            <div style="font-size:14px; font-weight:bold; color:#111827;">{{author}}</div>
            <div style="font-size:12px; color:#6b7280;">{{role}}</div>
          </td>
        </tr>
      </table>
    </td></tr>
  </table>
</td></tr>
`.trim());

      add("Grid ‚Äî Products 2x2", `
<tr><td align="center" style="padding:20px 16px;">
  <table width="100%" role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p1Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p1Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p1Desc}}</div>
        <a href="{{p1Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p1Cta}}</a>
      </td>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p2Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p2Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p2Desc}}</div>
        <a href="{{p2Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p2Cta}}</a>
      </td>
    </tr>
    <tr>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p3Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p3Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p3Desc}}</div>
        <a href="{{p3Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p3Cta}}</a>
      </td>
      <td class="stack" width="50%" align="center" style="padding:8px;">
        <img src="{{p4Image}}" width="260" style="border-radius:8px; width:100%; height:auto;" alt="">
        <div style="font-size:14px; font-weight:bold; color:#111827; padding-top:8px;">{{p4Title}}</div>
        <div style="font-size:13px; color:#6b7280; padding:4px 0 8px;">{{p4Desc}}</div>
        <a href="{{p4Url}}" style="display:inline-block; background:{{brandColor}}; color:#fff; text-decoration:none; padding:8px 14px; border-radius:6px; font-weight:bold;">{{p4Cta}}</a>
      </td>
    </tr>
  </table>
</td></tr>
`.trim());

      add("Section ‚Äî Rich Text", `
<tr><td align="left" style="padding:24px 28px;">
  <div style="font-size:20px; font-weight:bold; color:#111827; padding-bottom:8px;">{{richTitle}}</div>
  <div style="font-size:14px; color:#374151; line-height:1.7;">{{richBody}}</div>
</td></tr>
`.trim());

      // FOOTER
      add("FOOTER ‚Äî Social + Legal + Close", `
<tr><td align="center" style="padding:24px 28px; border-top:1px solid #e5e7eb;">
  <table role="presentation" cellpadding="0" cellspacing="0">
    <tr>
      <td style="padding:0 6px;"><a href="{{facebookUrl}}"><img src="{{facebookIconUrl}}" alt="Facebook" width="24" height="24"></a></td>
      <td style="padding:0 6px;"><a href="{{twitterUrl}}"><img src="{{twitterIconUrl}}" alt="Twitter" width="24" height="24"></a></td>
      <td style="padding:0 6px;"><a href="{{linkedinUrl}}"><img src="{{linkedinIconUrl}}" alt="LinkedIn" width="24" height="24"></a></td>
      <td style="padding:0 6px;"><a href="{{instagramUrl}}"><img src="{{instagramIconUrl}}" alt="Instagram" width="24" height="24"></a></td>
    </tr>
  </table>
  <div style="font-size:12px; color:#6b7280; line-height:1.6; padding-top:12px;">
    {{companyAddress}} ‚Ä¢ <a href="{{unsubscribeUrl}}" style="color:{{brandColor}}; text-decoration:underline;">Unsubscribe</a>
  </div>
</td></tr>
</table></td></tr></table></body></html>
`.trim());

      modules = m;
      saveModules();
    }

    /* ===== Utils ===== */
    function uid(p="id"){ return p+"_"+Math.random().toString(36).slice(2,8)+Date.now().toString(36); }
    function getProject(id){ return projects.find(p => p.id === id); }
    function getModule(id){ return modules.find(m => m.id === id); }
    function extractVars(code){ const m = code.match(/{{\s*([\w.\-]+)\s*}}/g) || []; return [...new Set(m.map(t => t.replace(/{{\s*|\s*}}/g,"")))] }
    function normalizeHexIfColor(key, value){
      if (!value) return value;
      if (!/(color|colour|bg|background|brand|ctaColor|bannerBg)/i.test(key)) return value;
      let v = String(value).trim(); if (!v) return v;
      if (v.startsWith("#")) v = v.slice(1);
      if (/^[0-9a-fA-F]{3}$/.test(v) || /^[0-9a-fA-F]{6}$/.test(v)) return "#" + v.toUpperCase();
      return value;
    }
    function applyValues(code, values){
      const normalized = {};
      for (const k in values) normalized[k] = normalizeHexIfColor(k, values[k]);
      return code.replace(/{{\s*([\w.\-]+)\s*}}/g, (_, k) => (normalized[k] ?? ""));
    }

    /* ===== Projects list ===== */
    function renderProjectsList(){
      projectsList.innerHTML = "";
      if (projects.length === 0){
        projectsList.innerHTML = `<div class="empty pill">No projects yet ‚Äî click ‚ÄúNew Project‚Äù.</div>`;
        return;
      }
      projects
        .slice()
        .sort((a,b)=> new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt))
        .forEach(p => {
          const row = document.createElement("div");
          row.className = "proj-row";
          const count = (p.instances||[]).length;
          row.innerHTML = `
            <div><strong>${p.name}</strong></div>
            <div class="pill">${count} module${count!==1?"s":""}</div>
            <div class="pill">${new Date(p.updatedAt||p.createdAt).toLocaleString()}</div>
            <div style="text-align:right;"><button class="btn" data-id="${p.id}">Open</button></div>
          `;
          qs(row, "button").addEventListener("click", ()=> go(`#/composer/${p.id}`));
          projectsList.appendChild(row);
        });
    }
    function newProject(){
      const name = prompt("Project name?");
      if (!name) return;
      const id = uid("proj");
      const now = new Date().toISOString();
      projects.push({ id, name, createdAt: now, updatedAt: now, instances: [] });
      saveProjects();
      go(`#/composer/${id}`);
    }

    /* ===== Composer (per project) ===== */
    function buildAddDropdown(){
      addSelect.innerHTML = `<option value="">Select a module‚Ä¶</option>`;
      modules.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id; opt.text = m.name;
        addSelect.appendChild(opt);
      });
      btnAdd.onclick = () => {
        const moduleId = addSelect.value;
        if (!moduleId) return;
        const mod = getModule(moduleId);
        const p = getProject(currentProjectId);
        const instance = { instanceId: uid("inst"), moduleId, values: {} };
        extractVars(mod.code).forEach(k => (instance.values[k] = ""));
        p.instances.push(instance);
        p.updatedAt = new Date().toISOString();
        saveProjects();
        addSelect.value = "";
        renderComposerInputs(); renderPreviewOnly();
      };
    }

    function renderComposerInputs(){
      const p = getProject(currentProjectId);
      const composer = p.instances || [];
      nvGrid.innerHTML = "";
      if (composer.length === 0){
        const empty = document.createElement("div");
        empty.className = "pill"; empty.style.gridColumn = "1 / span 2";
        empty.textContent = "No modules yet ‚Äî add one below.";
        nvGrid.appendChild(empty);
        previewCol.innerHTML = `<div class="pill" style="display:inline-block">Nothing to preview yet.</div>`;
        return;
      }

      composer.forEach(inst => {
        const mod = getModule(inst.moduleId);
        if (!mod) return;
        const keys = extractVars(mod.code);
        inst.values = inst.values || {};
        keys.forEach(k => { if (!(k in inst.values)) inst.values[k] = ""; });

        // Separator row (drag handle + delete)
        const sep = document.createElement("div");
        sep.className = "sep"; sep.style.gridColumn = "1 / span 2"; sep.draggable = true;
        sep.dataset.instanceId = inst.instanceId;
        const handle = document.createElement("div");
        handle.className = "handle"; handle.innerHTML = `‚ò∞ ${mod.name}`;
        const del = document.createElement("button");
        del.className = "btn danger"; del.textContent = "Delete";
        del.onclick = () => {
          p.instances = p.instances.filter(x => x.instanceId !== inst.instanceId);
          p.updatedAt = new Date().toISOString();
          saveProjects();
          renderComposerInputs(); renderPreviewOnly();
        };
        sep.appendChild(handle); sep.appendChild(del);
        nvGrid.appendChild(sep);

        // Drop indicator
        const drop = document.createElement("div");
        drop.className = "drop";
        nvGrid.appendChild(drop);

        // Aligned rows (name | value)
        keys.forEach(k => {
          const nameCell = document.createElement("div");
          nameCell.className = "name-chip";
          nameCell.textContent = k;
          nvGrid.appendChild(nameCell);

          const valueCell = document.createElement("div");
          valueCell.className = "value-row";
          const input = document.createElement("input");
          input.placeholder = `Value for ${k}`;
          input.value = normalizeHexIfColor(k, inst.values[k] ?? "");
          input.dataset.instanceId = inst.instanceId;
          input.dataset.key = k;

          input.addEventListener("input", e => {
            const { instanceId, key } = e.target.dataset;
            const ci = p.instances.find(x => x.instanceId === instanceId);
            if (!ci) return;
            ci.values[key] = normalizeHexIfColor(key, e.target.value);
            p.updatedAt = new Date().toISOString();
            saveProjects();
            renderPreviewOnly();
          });
          input.addEventListener("blur", e => {
            const { instanceId, key } = e.target.dataset;
            const ci = p.instances.find(x => x.instanceId === instanceId);
            if (!ci) return;
            const norm = normalizeHexIfColor(key, e.target.value);
            e.target.value = norm;
            ci.values[key] = norm;
            p.updatedAt = new Date().toISOString();
            saveProjects();
          });

          valueCell.appendChild(input);
          nvGrid.appendChild(valueCell);
        });

        // DnD
        sep.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", inst.instanceId);
          sep.classList.add("dragging");
        });
        sep.addEventListener("dragend", () => {
          sep.classList.remove("dragging");
          [...nvGrid.querySelectorAll(".drop")].forEach(d => d.classList.remove("active"));
        });
      });

      // grid-level dragover/drop
      nvGrid.onDragOverAttached || (nvGrid.onDragOverAttached = (
        nvGrid.addEventListener("dragover", e => {
          e.preventDefault();
          const indicators = [...nvGrid.querySelectorAll(".drop")];
          let closest = null, closestDist = Infinity;
          indicators.forEach(ind => {
            const r = ind.getBoundingClientRect();
            const dist = Math.abs(e.clientY - r.top);
            if (dist < closestDist){ closestDist = dist; closest = ind; }
            ind.classList.remove("active");
          });
          if (closest) closest.classList.add("active");
        }, { passive:false })
      ));
      nvGrid.onDropAttached || (nvGrid.onDropAttached = (
        nvGrid.addEventListener("drop", e => {
          e.preventDefault();
          const p = getProject(currentProjectId);
          const srcId = e.dataTransfer.getData("text/plain");
          const indicators = [...nvGrid.querySelectorAll(".drop")];
          const activeIdx = indicators.findIndex(d => d.classList.contains("active"));
          indicators.forEach(d => d.classList.remove("active"));
          if (activeIdx < 0) return;

          const seps = [...nvGrid.querySelectorAll(".sep")];
          const destIndex = Math.min(activeIdx, seps.length);
          const srcIndex = p.instances.findIndex(i => i.instanceId === srcId);
          if (srcIndex < 0) return;

          const [moved] = p.instances.splice(srcIndex, 1);
          p.instances.splice(destIndex, 0, moved);
          p.updatedAt = new Date().toISOString();
          saveProjects();
          renderComposerInputs(); renderPreviewOnly();
        })
      ));
    }

    function renderPreviewOnly(){
      const p = getProject(currentProjectId);
      if (!p){ previewCol.innerHTML = ""; return; }
      let html = "";
      (p.instances || []).forEach(inst => {
        const mod = getModule(inst.moduleId); if (!mod) return;
        html += `<div class="frame">${applyValues(mod.code, inst.values||{})}</div>`;
      });
      previewCol.innerHTML = html || `<div class="pill" style="display:inline-block">Nothing to preview yet.</div>`;
    }

    /* ===== Modules Repo (Code Editor) ===== */
    function renderRepo(){
      repoList.innerHTML = "";
      modules.forEach(m => {
        const item = document.createElement("div");
        item.className = "repo-item";
        item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <strong>${m.name}</strong><span class="pill">${m.id}</span>
        </div>`;
        item.addEventListener("click", ()=> loadModuleForEdit(m.id));
        repoList.appendChild(item);
      });
      if (editingModuleId){
        const mm = modules.find(x => x.id === editingModuleId);
        if (mm){ modName.value = mm.name; modCode.value = mm.code; modIdBadge.textContent = mm.id; }
      } else {
        modName.value = ""; modCode.value = ""; modIdBadge.textContent = "New";
      }
    }
    function loadModuleForEdit(id){
      const m = modules.find(x => x.id === id); if (!m) return;
      editingModuleId = id; modName.value = m.name; modCode.value = m.code; modIdBadge.textContent = id;
    }
    btnNew.addEventListener("click", ()=>{ editingModuleId = null; modName.value = ""; modCode.value = ""; modIdBadge.textContent = "New"; });
    btnSaveModule.addEventListener("click", ()=>{
      const name = modName.value.trim(); const code = modCode.value;
      if (!name || !code){ alert("Please provide a module name and HTML"); return; }
      if (editingModuleId){
        const i = modules.findIndex(m => m.id === editingModuleId);
        if (i >= 0) modules[i] = { ...modules[i], name, code };
      } else {
        const id = uid("mod"); modules.push({ id, name, code }); editingModuleId = id; modIdBadge.textContent = id;
      }
      saveModules(); renderRepo(); // update composer add dropdown if currently in composer
      if (location.hash.startsWith("#/composer/")) buildAddDropdown();
    });
    btnDeleteModule.addEventListener("click", ()=>{
      if (!editingModuleId) return;
      const id = editingModuleId;
      // remove from modules
      modules = modules.filter(m => m.id !== id);
      saveModules();
      // remove instances referencing it
      projects.forEach(p => {
        const before = p.instances?.length || 0;
        p.instances = (p.instances || []).filter(inst => inst.moduleId !== id);
        if (p.instances.length !== before) p.updatedAt = new Date().toISOString();
      });
      saveProjects();
      editingModuleId = null; modName.value = ""; modCode.value = ""; modIdBadge.textContent = "New";
      renderRepo();
      if (location.hash.startsWith("#/composer/")){
        buildAddDropdown(); renderComposerInputs(); renderPreviewOnly();
      }
    });

    /* ===== Copy HTML from Composer ===== */
    btnCopy.addEventListener("click", async ()=>{
      if (!location.hash.startsWith("#/composer/")) return;
      try{
        await navigator.clipboard.writeText(previewCol.innerHTML);
        const old = btnCopy.textContent; btnCopy.textContent = "Copied!";
        setTimeout(()=> btnCopy.textContent = old, 1200);
      }catch{ alert("Copy failed. Select the preview and copy manually."); }
    });

    /* ===== Boot ===== */
    (function init(){
      loadAll();
      renderRoute();
    })();
  </script>
</body>
</html>
